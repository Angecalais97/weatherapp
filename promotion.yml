version: 0.2
### This buildspec is for the promotion pipeline
phases:
  pre_build:
    commands:
      - curl -s https://get.helm.sh/helm-v3.7.2-linux-amd64.tar.gz  | tar xzf - linux-amd64/helm  --strip-components 1 && mv helm /usr/local/bin
      - curl -sL "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" -o /usr/local/bin/kubectl && chmod +x /usr/local/bin/kubectl
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $IMAGE_REPO_NAME
  build:
    commands:
      - echo "Promoting Docker images"
      - docker pull $IMAGE_REPO_NAME/weatherapp-ui:$TAGGED_HASH
      - docker pull $IMAGE_REPO_NAME/weatherapp-auth:$TAGGED_HASH
      - docker pull $IMAGE_REPO_NAME/weatherapp-weather:$TAGGED_HASH
      - docker tag $IMAGE_REPO_NAME/weatherapp-ui:$TAGGED_HASH $CI_REGISTRY_USER/weatherapp-ui:$CI_COMMIT_TAG
      - docker tag $IMAGE_REPO_NAME/weatherapp-auth:$TAGGED_HASH $CI_REGISTRY_USER/weatherapp-auth:$CI_COMMIT_TAG
      - docker tag $IMAGE_REPO_NAME/weatherapp-weather:$TAGGED_HASH $CI_REGISTRY_USER/weatherapp-weather:$CI_COMMIT_TAG
      - docker push $IMAGE_REPO_NAME/weatherapp-ui:$CI_COMMIT_TAG
      - docker push $IMAGE_REPO_NAME/weatherapp-auth:$CI_COMMIT_TAG
      - docker push $IMAGE_REPO_NAME/weatherapp-weather:$CI_COMMIT_TAG    
  post_build:
    commands:
      - docker push $IMAGE_REPO_NAME/weatherapp-auth:$CI_COMMIT_TAG
      - docker push $IMAGE_REPO_NAME/weatherapp-ui:$CI_COMMIT_TAG
      - docker push $IMAGE_REPO_NAME/weatherapp-weather:$CI_COMMIT_TAG
